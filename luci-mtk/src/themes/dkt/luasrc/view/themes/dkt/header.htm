<%#
 Copyright 2008 Steven Barth <steven@midlink.org>
 Copyright 2008-2010 Jo-Philipp Wich <jow@openwrt.org>
 Copyright 2016 DKT Comega <info@dktcomega.com>
 Licensed to the public under the Apache License 2.0.
-%>

<%
        local sys  = require "luci.sys"
        local http = require "luci.http"
        local disp = require "luci.dispatcher"

        local request  = disp.context.path
        local request2 = disp.context.request

        local category = request[1]
        local cattree  = category and disp.node(category)

        local leaf = request2[#request2]

        local tree = disp.node()
        local node = disp.context.dispatched

        local categories = disp.node_childs(tree)

        local c = tree
        local i, r

        -- tag all nodes leading to this page
        for i, r in ipairs(request) do
                if c.nodes and c.nodes[r] then
                        c = c.nodes[r]
                        c._menu_selected = true
                end
        end

        http.prepare_content("application/xhtml+xml")

        local function nodeurl(prefix, name, query)
                local url = controller .. prefix .. name .. "/"
                if query then
                        url = url .. http.build_querystring(query)
                end
                return pcdata(url)
        end

        local function subtree(prefix, node, level)
                if not level then
                        level = 1
                end

                local childs = disp.node_childs(node)
                if #childs > 0 then
%>
        <ul class="tabmenu l<%=level%>">
                <%
                        local selected_node
                        local selected_name
                        local i, v

                        if level==1 then
%>
                        <div id="dkttopmenuarea">
                         <div id="dktlogo"><img src="<%=media%>/DKT_logo_dktcomega.gif" /></div>
                         <div class="dkttopmenu">
<%
                        else
%>
                         <div class="dktsubmenu">
<%
                        end
                        for i, v in ipairs(childs) do
                                local nnode = node.nodes[v]
                                if nnode._menu_selected then
                                        selected_node = nnode
                                        selected_name = v
                                end
                %>
                        <li class="tabmenu-item-<%=v%><% if nnode._menu_selected or (node.leaf and v == leaf) then %> active<% end %>">
                        <a id="menutableft1<% if nnode._menu_selected or (node.leaf and v == leaf) then %>active<% end %>" href="<%=nodeurl(prefix, v, nnode.query)%>"><span id="menutabright1<% if nnode._menu_selected or (node.leaf and v == leaf) then %>active<% end %>"><%=striptags(translate(nnode.title))%></span></a>
                        </li>
                <%
                        end
                        if level==1 then
                %>
                        </div>
<%
                        end
%>
                        </div>
        </ul>
<%
                        if level>1 then
%>
     <div class="dkt_boxdefault">
      <div class="t"><div class="b"><div class="l"><div class="r"><div class="bl"><div class="br"><div class="tl"><div class="tr">
       <div class="dkt_boxcontent">
<%
                        end
%>
<%
                        if selected_node then
                                subtree(prefix .. selected_name .. "/", selected_node, level + 1)
                        end
                end
        end
-%>

<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<%=luci.i18n.context.lang%>" lang="<%=luci.i18n.context.lang%>">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<link rel="stylesheet" type="text/css" media="screen" href="<%=media%>/cascade.css" />
<!--[if IE 6]><link rel="stylesheet" type="text/css" media="screen" href="<%=media%>/ie6.css" /><![endif]-->
<!--[if IE 7]><link rel="stylesheet" type="text/css" media="screen" href="<%=media%>/ie7.css" /><![endif]-->
<!--[if IE 8]><link rel="stylesheet" type="text/css" media="screen" href="<%=media%>/ie8.css" /><![endif]-->
<% if node and node.css then %><link rel="stylesheet" type="text/css" media="screen" href="<%=resource%>/<%=node.css%>" />
<% end -%>
<% if css then %><style title="text/css">
<%= css %>
</style>
<% end -%>
<script type="text/javascript" src="<%=resource%>/xhr.js"></script>
<title>DKT Comega IPLoC WiFi <%=striptags( ( (node and node.title) and ' - ' .. translate(node.title) or '')) %></title>
</head>
<body class="lang_<%=luci.i18n.context.lang%>">
<div align="center">
 <div id="dkt_master">
  <div id="dkttop">
   <p class="skiplink">
    <span id="skiplink1"><a href="#navigation"><%:Skip to navigation%></a></span>
    <span id="skiplink2"><a href="#content"><%:Skip to content%></a></span>
   </p>
   <div id="maincontainer">
    <div id="tabmenu">
                <% if category then subtree("/" .. category .. "/", cattree) end %>

    <div id="maincontent">

                <noscript>
                        <div class="errorbox">
                                <strong><%:Java Script required!%></strong><br />
                                <%:You must enable Java Script in your browser or LuCI will not work properly.%>
                        </div>
                </noscript>

                <%- if luci.sys.process.info("uid") == 0 and luci.sys.user.getuser("root") and not luci.sys.user.getpasswd("root") and category ~= "failsafe" then -%>
                <div class="errorbox">
                        <strong><%:No password set!%></strong><br />
                        <%:There is no password set on this router. Please configure a root password to protect the web interface and enable SSH.%><br />
                        <a href="<%=pcdata(luci.dispatcher.build_url("admin/system/admin"))%>"><%:Go to password configuration...%></a>
                </div>
                <%- end -%>
